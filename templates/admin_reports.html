<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Reports - HIRA IST</title>
<link rel="icon" type="image/x-icon" href="../static/image/hira_logo.png">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  .pdf-content {
    line-height: 1.15;
    font-family: sans-serif;
    padding: 0.3in;
  }

  .pdf-table {
    width: 100%;
    border-collapse: collapse;
  }

  .pdf-table th, .pdf-table td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    font-size: 11px;
  }

  .page-break {
    page-break-inside: avoid;
  }

  canvas {
    display: block;
    margin: 0 auto;
  }

  /* Screen view logo centered */
  .pdf-logo {
    display: block;
    margin: 0 auto;
  }

  /* PRINT / PDF ONLY */
  @media print {

    #downloadPdf {
      display: none !important;
    }

    .pdf-logo {
      position: absolute;
      top: 10mm;
      left: 10mm;
      margin: 0;
    }

    .pdf-content {
      padding-top: 40mm;
    }
  }
</style>
</head>

<body class="bg-gray-100 font-sans">

<div class="max-w-6xl mx-auto p-2 pdf-content" id="reportContent">

  <!-- Logo & Title -->
  <div class="text-center mb-2 page-break">
    <img src="../static/image/hira_logo_main.png" alt="HIRA Logo" class="pdf-logo w-28">
    <h2 class="text-2xl font-bold text-indigo-600 mt-1">Admin Report</h2>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 mb-2 page-break">
    <div class="bg-white rounded-xl shadow p-2 text-center">
      <p class="text-2xl mb-1">üéì</p>
      <h3 class="font-semibold text-gray-700">Total Students</h3>
      <p class="font-bold text-indigo-600">{{ total_students }}</p>
    </div>

    <div class="bg-white rounded-xl shadow p-2 text-center">
      <p class="text-2xl mb-1">‚ùó</p>
      <h3 class="font-semibold text-gray-700">Total Queries</h3>
      <p class="font-bold text-indigo-600">{{ total_queries }}</p>
    </div>

    <div class="bg-white rounded-xl shadow p-2 text-center">
      <p class="text-2xl mb-1">üè¢</p>
      <h3 class="font-semibold text-gray-700">Total Departments</h3>
      <p class="font-bold text-indigo-600">{{ department_students|length }}</p>
    </div>
  </div>

  <!-- Pie Chart -->
  <div class="bg-white rounded-xl shadow p-2 mb-2 page-break">
    <h3 class="font-semibold mb-1 text-center">Department-wise Students</h3>
    <canvas id="deptPieChart" width="300" height="300"></canvas>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-xl shadow p-2 overflow-x-auto mb-2 page-break">
    <h3 class="font-semibold mb-1">Department Students List</h3>
    <table class="pdf-table">
      <thead class="bg-gray-100">
        <tr>
          <th>Register Number</th>
          <th>Name</th>
          <th>Department</th>
          <th>Results Published</th>
          <th>Attendance Posted</th>
          <th>Query Status</th>
        </tr>
      </thead>
      <tbody>
        {% for s in report %}
        <tr class="student-row" data-department="{{ s.department }}">
          <td>{{ s.register_no }}</td>
          <td>{{ s.name }}</td>
          <td>{{ s.department }}</td>
          <td class="text-center">{% if s.result_summary|length > 0 %}Published{% else %}Pending{% endif %}</td>
          <td class="text-center">{% if s.attendance_posted %}Posted{% else %}Pending{% endif %}</td>
          <td class="text-center">
            {% if s.query_status %}
              {% if s.query_status == "Pending" %}‚è≥ Pending{% elif s.query_status == "Replied" %}‚úÖ Replied{% endif %}
            {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Download Button (screen only) -->
  <div class="text-center mb-2 page-break">
    <button id="downloadPdf"
      class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
      Download PDF
    </button>
  </div>

</div>

<script>
  const ctx = document.getElementById('deptPieChart').getContext('2d');

  const deptLabels = {{ department_students | map(attribute='_id') | list | tojson }};
  const deptData = {{ department_students | map(attribute='student_count') | list | tojson }};

  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: deptLabels,
      datasets: [{
        data: deptData,
        backgroundColor: [
          '#6366F1','#F87171','#34D399','#FBBF24',
          '#60A5FA','#F472B6','#A78BFA','#FBBF24'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { boxWidth: 20, padding: 10 }
        }
      }
    }
  });

  document.getElementById('downloadPdf').addEventListener('click', () => {
    html2pdf().set({
      margin: [10,10,10,10],
      filename: 'Admin_Report.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(document.getElementById('reportContent')).save();
  });
</script>

</body>
</html>
