<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Reports - HIRA IST</title>
<link rel="icon" type="image/x-icon" href="../static/image/hira_logo.png">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  .pdf-content {
    font-family: "Inter", sans-serif;
    line-height: 1.3;
    padding: 12mm;
  }

  .pdf-table {
    width: 100%;
    border-collapse: collapse;
  }

  .pdf-table th, .pdf-table td {
    border: 1px solid #e5e7eb;
    padding: 6px;
    font-size: 11px;
  }

  .page-break {
    page-break-inside: avoid;
  }

  canvas {
    margin: auto;
  }

  /* ===== PDF ONLY ===== */
  @media print {

    #downloadPdf {
      display: none !important;
    }

    .pdf-logo {
      position: fixed;
      top: 10mm;
      left: 10mm;
      width: 90px;
    }

    .pdf-header {
      margin-top: 25mm;
      text-align: center;
    }
  }
</style>
</head>

<body class="bg-slate-100 text-gray-800">

<div id="reportContent" class="max-w-7xl mx-auto pdf-content">

  <!-- Logo -->
  <img src="../static/image/hira_logo_main.png"
       class="pdf-logo mx-auto mb-2 w-28"
       alt="HIRA Logo">

  <!-- Title -->
  <div class="pdf-header mb-4">
    <h2 class="text-2xl font-bold text-indigo-700 tracking-wide">
      Admin Report
    </h2>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-4 page-break">

    <div class="bg-white rounded-xl shadow-md p-3 text-center border-t-4 border-indigo-600">
      <p class="text-2xl">üéì</p>
      <h3 class="font-semibold text-sm text-gray-600">Total Students</h3>
      <p class="text-xl font-bold text-indigo-700">{{ total_students }}</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-3 text-center border-t-4 border-rose-500">
      <p class="text-2xl">‚ùó</p>
      <h3 class="font-semibold text-sm text-gray-600">Total Queries</h3>
      <p class="text-xl font-bold text-rose-600">{{ total_queries }}</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-3 text-center border-t-4 border-emerald-500">
      <p class="text-2xl">üè¢</p>
      <h3 class="font-semibold text-sm text-gray-600">Departments</h3>
      <p class="text-xl font-bold text-emerald-600">
        {{ department_students|length }}
      </p>
    </div>

  </div>

  <!-- Chart -->
<!-- Chart -->
<div class="bg-white rounded-xl shadow-md p-3 mb-4 page-break">
  <h3 class="font-semibold text-center text-sm mb-2">
    Department-wise Students
  </h3>

  <!-- Responsive Chart Wrapper -->
  <div class="relative w-full mx-auto max-w-sm h-[260px] sm:h-[320px]">
    <canvas id="deptPieChart" class="!w-full !h-full"></canvas>
  </div>
</div>



  <!-- Table -->
  <div class="bg-white rounded-xl shadow-md p-3 overflow-x-auto page-break">

    <h3 class="font-semibold text-sm mb-2">
      Department Students List
    </h3>

    <table class="pdf-table">
      <thead class="bg-gray-100">
        <tr>
          <th>Register No</th>
          <th>Name</th>
          <th>Department</th>
          <th>Results</th>
          <th>Attendance</th>
          <th>Query</th>
        </tr>
      </thead>
      <tbody>
        {% for s in report %}
        <tr>
          <td>{{ s.register_no }}</td>
          <td>{{ s.name }}</td>
          <td>{{ s.department }}</td>
          <td class="text-center">
            {% if s.result_summary|length > 0 %}Published{% else %}Pending{% endif %}
          </td>
          <td class="text-center">
            {% if s.attendance_posted %}Posted{% else %}Pending{% endif %}
          </td>
          <td class="text-center">
            {% if s.query_status %}
              {% if s.query_status == "Pending" %}‚è≥ Pending{% else %}‚úÖ Replied{% endif %}
            {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <!-- Button (Screen Only) -->
  <div class="text-center mt-4">
    <button id="downloadPdf"
      class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow transition">
      Download PDF
    </button>
  </div>

</div>

<script>
  const ctx = document.getElementById('deptPieChart').getContext('2d');

  const deptLabels = {{ department_students | map(attribute='_id') | list | tojson }};
  const deptData = {{ department_students | map(attribute='student_count') | list | tojson }};

new Chart(ctx, {
  type: 'pie',
  data: {
    labels: deptLabels,
    datasets: [{
      data: deptData,
      backgroundColor: [
        '#6366F1','#F87171','#34D399','#FBBF24',
        '#60A5FA','#F472B6','#A78BFA','#22C55E'
      ]
    }]
  },
options: {
  responsive: true,
  maintainAspectRatio: false, // ‚≠ê VERY IMPORTANT
  plugins: {
    legend: {
      position: 'bottom',
      labels: {
        boxWidth: 12,
        padding: 10,
        font: {
          size: 11
        }
      }
    }
  }
}
);


  document.getElementById('downloadPdf').addEventListener('click', () => {
    html2pdf().set({
      margin: 10,
      filename: 'Admin_Report.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(document.getElementById('reportContent')).save();
  });
</script>

</body>
</html>


